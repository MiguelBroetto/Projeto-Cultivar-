<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HistÃ³rico de Compras</title>
    <link rel="stylesheet" href="geral.css">
    <link rel="stylesheet" href="historico.css">
</head>

<body>
    <header class="header">
        <div class="logo">
            <img src="./imagens/logo cultivar +(sem fundo).png" alt="Logo do Site">
        </div>
        <nav class="nav-links">
            <a href="index.html"><img src="./imagens/home.png" alt="InÃ­cio"></a>
            <a href="sobre.html"><img src="./imagens/Sobre (1).png" alt="Sobre"></a>
            <a href="carrinho.html"><img src="./imagens/carrinho.png" alt="Carrinho"></a>
        </nav>
        <div class="actions">
            <button class="settings" id="settingsBtn">
                <img src="./imagens/configuracao.png" alt="ConfiguraÃ§Ãµes">
            </button>
        </div>

        <div class="dropdown" id="dropdownMenu">
            <a href="perfil.html" class="item">
                <img src="./imagens/perfil (1).png" alt="Perfil">
                <span>Perfil</span>
            </a>
            <a href="historico.html" class="item">
                <img src="./imagens/historia.png" alt="HistÃ³rico">
                <span>HistÃ³rico</span>
            </a>
            <a href="admin.html" class="item">
                <img src="./imagens/homem-de-terno-e-gravata.png" alt="Admin">
                <span>Admin</span>
            </a>
            <a href="contato.html" class="item">
                <img src="./imagens/contato (1).png" alt="contato">
                <span>Contato</span>
            </a>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">ðŸ“‹ Meu HistÃ³rico de Compras</h1>
            <p class="page-subtitle">Acompanhe todos os seus pedidos realizados</p>
        </div>

        <div class="main-content">
            <!-- Avisos -->
            <div id="usuarioNaoLogado" class="aviso" style="display: none;">
                <div class="aviso-conteudo">
                    <h2>ðŸ”’ Acesso Restrito</h2>
                    <p>VocÃª precisa estar logado para ver seu histÃ³rico de compras.</p>
                    <a href="perfil.html" class="btn-login">Fazer Login</a>
                </div>
            </div>

            <div id="historicoVazio" class="aviso" style="display: none;">
                <div class="aviso-conteudo">
                    <h2>ðŸ“­ Nenhuma Compra Encontrada</h2>
                    <p>VocÃª ainda nÃ£o realizou nenhuma compra.</p>
                    <a href="index.html" class="btn-comprar">Fazer Minha Primeira Compra</a>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filtros">
                <div class="filtro-grupo">
                    <label class="filtro-label" for="filtroStatus">Filtrar por status:</label>
                    <select class="filtro-select" id="filtroStatus">
                        <option value="todos">Todos os pedidos</option>
                        <option value="confirmado">Confirmados</option>
                        <option value="entregue">Entregues</option>
                        <option value="cancelado">Cancelados</option>
                    </select>
                </div>
                <div class="filtro-grupo">
                    <label class="filtro-label" for="filtroData">Ordenar por:</label>
                    <select class="filtro-select" id="filtroData">
                        <option value="recentes">Mais recentes</option>
                        <option value="antigos">Mais antigos</option>
                    </select>
                </div>
            </div>

            <!-- Lista de Pedidos -->
            <div id="historicoCompras">
                <div class="lista-pedidos" id="listaPedidos">
                    <!-- Os pedidos serÃ£o carregados aqui dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes do Pedido - CENTRALIZADO -->
    <div id="modalDetalhes" class="modal-pagamento">
        <div class="modal-conteudo modal-grande">
            <div class="detalhes-header">
                <h2>ðŸ“¦ Detalhes do Pedido</h2>
                <div class="detalhes-info">
                    <p><strong>NÃºmero:</strong> <span id="modalPedidoNumero">CV-2023-0012</span></p>
                    <p><strong>Data:</strong> <span id="modalPedidoData">15/11/2023</span></p>
                    <p><strong>Status:</strong> <span class="status entregue" id="modalPedidoStatus">Entregue</span></p>
                </div>
            </div>
            <div id="detalhesPedidoConteudo">
                <!-- ConteÃºdo dos detalhes serÃ¡ carregado aqui -->
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Cultivar +</p>
    </footer>
    <script>
        // ===============================
// ELEMENTOS PRINCIPAIS
// ===============================
const usuarioNaoLogado = document.getElementById('usuarioNaoLogado');
const historicoVazio = document.getElementById('historicoVazio');
const historicoCompras = document.getElementById('historicoCompras');
const listaPedidos = document.getElementById('listaPedidos');
const modalDetalhes = document.getElementById('modalDetalhes');
const fecharDetalhes = document.getElementById('fecharDetalhes');
const detalhesPedidoConteudo = document.getElementById('detalhesPedidoConteudo');
const filtroStatus = document.getElementById('filtroStatus');
const filtroData = document.getElementById('filtroData');

// ===============================
// INÃCIO
// ===============================
window.onload = function () {
    carregarHistorico();
    configurarEventos();
};

// ===============================
// CARREGAR HISTÃ“RICO
// ===============================
function carregarHistorico() {
    const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));

    if (!usuarioLogado) {
        usuarioNaoLogado.style.display = 'block';
        historicoCompras.style.display = 'none';
        historicoVazio.style.display = 'none';
        return;
    }

    let pedidos = [];

    if (usuarioLogado.pedidos) {
        pedidos = usuarioLogado.pedidos;
    }

    if (pedidos.length === 0) {
        const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
        const user = usuarios.find(u => u.email === usuarioLogado.email);
        if (user && user.pedidos) pedidos = user.pedidos;
    }

    if (pedidos.length === 0) {
        const todosPedidos = JSON.parse(localStorage.getItem('todosPedidos') || '[]');
        pedidos = todosPedidos.filter(p => p.usuarioEmail === usuarioLogado.email);
    }

    if (pedidos.length === 0) {
        historicoVazio.style.display = 'block';
        historicoCompras.style.display = 'none';
        usuarioNaoLogado.style.display = 'none';
        return;
    }

    usuarioNaoLogado.style.display = 'none';
    historicoVazio.style.display = 'none';
    historicoCompras.style.display = 'block';

    pedidos.sort((a, b) => new Date(b.data) - new Date(a.data));

    exibirPedidos(pedidos);
}

// ===============================
// EXIBIR PEDIDOS
// ===============================
function exibirPedidos(pedidos) {
    listaPedidos.innerHTML = '';

    pedidos.forEach(pedido => {
        const pedidoElement = document.createElement('div');
        pedidoElement.className = `pedido-item status-${(pedido.status || 'Confirmado').toLowerCase()}`;

        const totalFormatado = `R$ ${(pedido.total || 0).toFixed(2).replace('.', ',')}`;
        const itensQtd = pedido.itens ? pedido.itens.reduce((t, i) => t + (i.quantidade || 1), 0) : 0;
        const dataFormatada = pedido.dataFormatada || new Date(pedido.data).toLocaleDateString('pt-BR');

        pedidoElement.innerHTML = `
            <div class="pedido-header">
                <div class="pedido-info">
                    <h3>Pedido ${pedido.id}</h3>
                    <span class="pedido-data">${dataFormatada}</span>
                </div>
                <div class="pedido-status ${(pedido.status || 'Confirmado').toLowerCase()}">
                    ${getIconeStatus(pedido.status)} ${pedido.status}
                </div>
            </div>

            <div class="pedido-detalhes">
                <div class="detalhes-item"><span class="detalhes-label">Itens:</span> ${itensQtd}</div>
                <div class="detalhes-item"><span class="detalhes-label">Total:</span> ${totalFormatado}</div>
                <div class="detalhes-item"><span class="detalhes-label">Pagamento:</span> ${getIconePagamento(pedido.metodoPagamento)} ${pedido.metodoPagamento}</div>
            </div>

            <div class="pedido-acoes">
                <button onclick="verDetalhesPedido('${pedido.id}')">ðŸ“‹ Ver Detalhes</button>
            </div>
        `;

        listaPedidos.appendChild(pedidoElement);
    });
}

// ===============================
// DETALHES DO PEDIDO
// ===============================
function verDetalhesPedido(pedidoId) {
    const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
    let pedido = null;

    if (usuarioLogado.pedidos)
        pedido = usuarioLogado.pedidos.find(p => p.id === pedidoId);

    if (!pedido) {
        const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
        const user = usuarios.find(u => u.email === usuarioLogado.email);
        if (user && user.pedidos)
            pedido = user.pedidos.find(p => p.id === pedidoId);
    }

    if (!pedido) {
        const todosPedidos = JSON.parse(localStorage.getItem('todosPedidos') || '[]');
        pedido = todosPedidos.find(p => p.id === pedidoId && p.usuarioEmail === usuarioLogado.email);
    }

    detalhesPedidoConteudo.innerHTML = montarHTMLDetalhes(pedido);
    modalDetalhes.style.display = 'flex';
}

function montarHTMLDetalhes(pedido) {
    const itensHTML = pedido.itens.map(item => `
        <div class="item-detalhe">
            <img src="${item.imagem}" class="item-imagem">
            <div>
                <h4>${item.nome}</h4>
                <p>Qtd: ${item.quantidade}</p>
                <p>R$ ${parseFloat(item.preco.replace("R$", "")).toFixed(2)}</p>
            </div>
        </div>
    `).join('');

    return `
        <h2>Pedido ${pedido.id}</h2>
        <p><strong>Status:</strong> ${getIconeStatus(pedido.status)} ${pedido.status}</p>
        <p><strong>Data:</strong> ${pedido.dataFormatada}</p>
        <h3>Itens</h3>
        ${itensHTML}
    `;
}

// ===============================
// ÃCONES
// ===============================
function getIconeStatus(s) {
    if (s === 'Confirmado') return 'âœ…';
    if (s === 'Entregue') return 'ðŸ“¦';
    if (s === 'Cancelado') return 'âŒ';
    return 'ðŸ“‹';
}

function getIconePagamento(m) {
    if (m === 'Pix') return 'ðŸ¦';
    if (m === 'Boleto') return 'ðŸ“„';
    if (m === 'CartÃ£o de CrÃ©dito') return 'ðŸ’³';
    return 'ðŸ’°';
}

// ===============================
// EVENTOS (MODAL + FILTROS + MENU)
// ===============================
function configurarEventos() {

    // ---- FECHAR MODAL ----
    fecharDetalhes?.addEventListener('click', () => {
        modalDetalhes.style.display = 'none';
    });

    modalDetalhes?.addEventListener('click', e => {
        if (e.target === modalDetalhes) modalDetalhes.style.display = 'none';
    });

    // ---- FILTROS ----
    filtroStatus?.addEventListener('change', aplicarFiltros);
    filtroData?.addEventListener('change', aplicarFiltros);

    // ============================
    // MENU DE CONFIGURAÃ‡Ã•ES â€” CORRIGIDO âœ”
    // ============================
    const settingsBtn = document.getElementById('settingsBtn');
    const dropdownMenu = document.getElementById('dropdownMenu');

    if (settingsBtn && dropdownMenu) {

        // Abrir / Fechar o menu
        settingsBtn.addEventListener('click', e => {
            e.stopPropagation();
            dropdownMenu.classList.toggle('active');
        });

        // Fechar clicando fora
        document.addEventListener('click', e => {
            if (!dropdownMenu.contains(e.target) && !settingsBtn.contains(e.target)) {
                dropdownMenu.classList.remove('active');
            }
        });

        // Fechar com ESC
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') dropdownMenu.classList.remove('active');
        });
    }
}

// ===============================
// APLICAR FILTROS
// ===============================
function aplicarFiltros() {
    const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
    let pedidos = usuarioLogado.pedidos || [];

    const statusSelecionado = filtroStatus.value;
    if (statusSelecionado !== "todos")
        pedidos = pedidos.filter(p => p.status === statusSelecionado);

    const ordem = filtroData.value;
    pedidos.sort((a, b) =>
        ordem === "recentes"
            ? new Date(b.data) - new Date(a.data)
            : new Date(a.data) - new Date(b.data)
    );

    exibirPedidos(pedidos);
}
    </script>

</body>

</html>